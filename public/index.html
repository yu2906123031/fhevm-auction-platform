<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHEVM 机密拍卖平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0f0f23 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            min-height: 100vh;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 98px,
                    rgba(255, 255, 255, 0.03) 100px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 98px,
                    rgba(255, 255, 255, 0.03) 100px
                );
            pointer-events: none;
            z-index: -1;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(0, 255, 127, 0.05) 0%, transparent 30%);
            animation: aiGlow 8s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes aiGlow {
            0% {
                opacity: 0.3;
                transform: scale(1);
            }
            100% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-bar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .nav-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .wallet-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 20px rgba(120, 219, 255, 0.1);
            backdrop-filter: blur(25px);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        .card h2 {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
            text-shadow: 0 0 10px rgba(120, 219, 255, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 5px rgba(120, 219, 255, 0.2);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            color: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: rgba(120, 219, 255, 0.6);
            box-shadow: 
                0 0 0 3px rgba(120, 219, 255, 0.2),
                0 0 15px rgba(120, 219, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, rgba(120, 219, 255, 0.8) 0%, rgba(255, 119, 198, 0.8) 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 15px rgba(120, 219, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(120, 219, 255, 0.5),
                0 0 20px rgba(255, 119, 198, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status.info {
            background: #ebf8ff;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        /* FHEVM加载界面样式 */
        .fhevm-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loader-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .loader-header h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .loader-header p {
            color: #718096;
            margin-bottom: 30px;
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #78dbff 0%, #ff77c6 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            color: #4a5568;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .loader-actions {
            margin-bottom: 20px;
        }

        .loader-tips {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #78dbff;
        }

        .loader-tips p {
            color: #4a5568;
            margin: 0;
            font-size: 0.9rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .auction-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
            border: 1px solid rgba(255, 154, 158, 0.2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 1px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .auction-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 5px 20px rgba(255, 154, 158, 0.2);
            border-color: rgba(255, 154, 158, 0.4);
        }

        .auction-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #ffeaa7 100%);
            opacity: 0.8;
        }

        .auction-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 154, 158, 0.03) 0%, transparent 70%);
            pointer-events: none;
            transition: opacity 0.3s ease;
            opacity: 0;
        }

        .auction-card:hover::after {
            opacity: 1;
        }

        .auction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .auction-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .auction-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .auction-status.active {
            background: #c6f6d5;
            color: #22543d;
        }

        .auction-status.ended {
            background: #fed7d7;
            color: #742a2a;
        }

        .auction-status.settled {
            background: #bee3f8;
            color: #2a4365;
        }

        .auction-description {
            color: #4a5568;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .auction-details {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: #4a5568;
        }

        .detail-value {
            color: #2d3748;
            font-weight: 500;
        }

        .price-highlight {
            color: #ff9a9e;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .bid-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
        }

        .bid-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .bid-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .bid-input:focus {
            outline: none;
            border-color: #ff9a9e;
        }

        .countdown {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
            color: #c53030;
        }

        .user-info {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ff9a9e;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff9a9e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* 加载动画样式 */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff9a9e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .loading-container {
            text-align: center;
            padding: 40px 20px;
            background: #f7fafc;
            border-radius: 10px;
            margin: 20px 0;
        }

        .loading-container h3 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .loading-container p {
            color: #718096;
            margin-bottom: 20px;
        }

        .error-container {
            text-align: center;
            padding: 40px 20px;
            background: #fed7d7;
            border: 1px solid #feb2b2;
            border-radius: 10px;
            margin: 20px 0;
        }

        .error-container h3 {
            color: #c53030;
            margin-bottom: 10px;
        }

        .error-container p {
            color: #742a2a;
            margin-bottom: 20px;
        }

        .performance-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #234e52;
        }

        .tabs {
            display: flex;
            background: #f7fafc;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: white;
            color: #ff9a9e;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-bar {
                flex-direction: column;
                gap: 15px;
            }

            .wallet-section {
                width: 100%;
                justify-content: center;
            }

            .bid-input-group {
                flex-direction: column;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏛️ FHEVM 机密拍卖平台</h1>
            <p>基于完全同态加密的隐私保护拍卖系统</p>
        </div>

        <div class="nav-bar">
            <div class="nav-links">
                <a href="/">🏠 首页</a>
                <a href="/auctions">🏛️ 拍卖大厅</a>
                <a href="/my-auctions">📋 我的拍卖</a>
                <a href="/help">❓ 帮助</a>
            </div>
            <div class="wallet-section">
                <button id="connectWallet" class="btn">连接钱包</button>
                <span id="walletAddress" class="hidden"></span>
            </div>
        </div>

        <div id="status" class="status hidden"></div>
        
        <!-- FHEVM加载界面 -->
        <div id="fhevmLoader" class="fhevm-loader hidden">
            <div class="loader-content">
                <div class="loader-header">
                    <h3>🔐 正在初始化FHEVM加密库</h3>
                    <p>首次加载可能需要几秒钟时间...</p>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="progressText" class="progress-text">0%</div>
                </div>
                <div class="loader-actions">
                    <button id="skipFhevm" class="btn btn-secondary">跳过并使用模拟模式</button>
                </div>
                <div class="loader-tips">
                    <p>💡 提示：FHEVM库提供完全同态加密功能，确保竞拍价格的隐私性</p>
                </div>
            </div>
        </div>

        <!-- 用户信息 -->
        <div id="userInfo" class="card hidden">
            <h2>👤 用户信息</h2>
            <div class="user-info">
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="userBalance">0</div>
                        <div class="stat-label">账户余额 (ETH)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="lockedFunds">0</div>
                        <div class="stat-label">锁定资金 (ETH)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="myAuctions">0</div>
                        <div class="stat-label">我的拍卖</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="myBids">0</div>
                        <div class="stat-label">我的竞拍</div>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button id="withdrawFunds" class="btn btn-warning">提取可用资金</button>
                </div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('auctions')">🏛️ 拍卖列表</div>
                <div class="tab" onclick="switchTab('create')">➕ 创建拍卖</div>
                <div class="tab" onclick="switchTab('manage')">⚙️ 管理</div>
            </div>

            <!-- 拍卖列表 -->
            <div id="auctions" class="tab-content active">
                <div class="form-group">
                    <button id="loadAuctions" class="btn btn-secondary">刷新拍卖列表</button>
                </div>
                <div id="auctionsList" class="grid">
                    <!-- 拍卖将在这里动态加载 -->
                </div>
            </div>

            <!-- 创建拍卖 -->
            <div id="create" class="tab-content">
                <h2>创建新拍卖</h2>
                <div class="form-group">
                    <label for="itemName">物品名称:</label>
                    <input type="text" id="itemName" placeholder="输入拍卖物品名称">
                </div>
                <div class="form-group">
                    <label for="itemDescription">物品描述:</label>
                    <textarea id="itemDescription" placeholder="详细描述拍卖物品..."></textarea>
                </div>
                <div class="form-group">
                    <label for="startingPrice">起拍价格 (ETH):</label>
                    <input type="number" id="startingPrice" placeholder="0.1" step="0.001" min="0">
                </div>
                <div class="form-group">
                    <label for="reservePrice">保留价格 (ETH):</label>
                    <input type="number" id="reservePrice" placeholder="1.0" step="0.001" min="0">
                    <small style="color: #718096;">保留价格将被加密，只有达到此价格拍卖才会成功</small>
                </div>
                <div class="form-group">
                    <label for="auctionDuration">拍卖持续时间 (小时):</label>
                    <input type="number" id="auctionDuration" placeholder="24" min="1" max="168">
                </div>
                <button id="createAuction" class="btn">创建拍卖</button>
            </div>

            <!-- 管理面板 -->
            <div id="manage" class="tab-content">
                <h2>拍卖管理</h2>
                <div id="adminPanel" class="hidden">
                    <h3>管理员功能</h3>
                    <div class="form-group">
                        <label for="platformFee">平台费率 (%):</label>
                        <input type="number" id="platformFee" placeholder="2" min="0" max="10" step="0.1">
                        <button id="setPlatformFee" class="btn btn-secondary">设置费率</button>
                    </div>
                    <div class="form-group">
                        <label for="emergencyAuctionId">紧急停止拍卖ID:</label>
                        <input type="number" id="emergencyAuctionId" placeholder="0" min="0">
                        <button id="emergencyStop" class="btn btn-danger">紧急停止</button>
                    </div>
                </div>
                
                <h3>平台统计</h3>
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalAuctions">0</div>
                        <div class="stat-label">总拍卖数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeAuctions">0</div>
                        <div class="stat-label">活跃拍卖</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="platformFeeRate">0</div>
                        <div class="stat-label">平台费率 (%)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/fhevmjs@0.4.1/bundle/index.js"></script>
    <script>
        let provider, signer, contract, fhevmInstance;
        let userAddress = null;
        let isOwner = false;
        let countdownIntervals = {};
        
        // 错误处理和重试配置
        const ERROR_CONFIG = {
            maxRetries: 3,
            retryDelay: 1000, // 1秒
            timeoutDuration: 15000, // 15秒
            networkCheckInterval: 30000 // 30秒
        };
        
        // 连接状态管理
        let connectionState = {
            isConnected: false,
            lastError: null,
            retryCount: 0,
            networkStatus: 'unknown',
            lastSuccessfulCall: Date.now()
        };
        
        // 错误分类
        const ERROR_TYPES = {
            NETWORK: 'network',
            CONTRACT: 'contract',
            WALLET: 'wallet',
            TIMEOUT: 'timeout',
            USER: 'user',
            UNKNOWN: 'unknown'
        };

        // 智能重试机制
        async function retryWithBackoff(fn, context = '', maxRetries = ERROR_CONFIG.maxRetries) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const result = await Promise.race([
                        fn(),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('操作超时')), ERROR_CONFIG.timeoutDuration)
                        )
                    ]);
                    
                    // 成功时重置重试计数
                    connectionState.retryCount = 0;
                    connectionState.lastSuccessfulCall = Date.now();
                    return result;
                } catch (error) {
                    lastError = error;
                    const errorType = classifyError(error);
                    
                    console.warn(`${context} 尝试 ${attempt}/${maxRetries} 失败:`, {
                        error: error.message,
                        type: errorType,
                        code: error.code
                    });
                    
                    // 如果是用户取消或某些不可重试的错误，直接抛出
                    if (errorType === ERROR_TYPES.USER || 
                        error.code === 4001 || 
                        error.message?.includes('User denied') ||
                        attempt === maxRetries) {
                        break;
                    }
                    
                    // 指数退避延迟
                    const delay = ERROR_CONFIG.retryDelay * Math.pow(2, attempt - 1);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            connectionState.retryCount++;
            connectionState.lastError = lastError;
            throw lastError;
        }
        
        // 错误分类函数
        function classifyError(error) {
            const message = error.message?.toLowerCase() || '';
            const code = error.code;
            
            // 用户操作错误
            if (code === 4001 || message.includes('user denied') || message.includes('user rejected')) {
                return ERROR_TYPES.USER;
            }
            
            // 网络错误
            if (message.includes('network') || message.includes('connection') || 
                message.includes('timeout') || message.includes('fetch') ||
                code === 'NETWORK_ERROR' || code === 'TIMEOUT') {
                return ERROR_TYPES.NETWORK;
            }
            
            // 合约调用错误
            if (message.includes('call_exception') || message.includes('execution reverted') ||
                message.includes('insufficient funds') || message.includes('gas') ||
                code === 'CALL_EXCEPTION' || code === 'UNPREDICTABLE_GAS_LIMIT') {
                return ERROR_TYPES.CONTRACT;
            }
            
            // 钱包错误
            if (message.includes('metamask') || message.includes('wallet') || 
                message.includes('provider') || code === 'UNSUPPORTED_OPERATION') {
                return ERROR_TYPES.WALLET;
            }
            
            // 超时错误
            if (message.includes('timeout') || message.includes('超时')) {
                return ERROR_TYPES.TIMEOUT;
            }
            
            return ERROR_TYPES.UNKNOWN;
        }
        
        // 网络状态监控
        function startNetworkMonitoring() {
            // 监听在线状态变化
            window.addEventListener('online', () => {
                connectionState.networkStatus = 'online';
                showStatus('网络连接已恢复', 'success');
            });
            
            window.addEventListener('offline', () => {
                connectionState.networkStatus = 'offline';
                showStatus('网络连接已断开', 'error');
            });
            
            // 定期检查连接状态
            setInterval(async () => {
                if (connectionState.networkStatus !== 'offline') {
                    const isOnline = await checkNetworkConnection();
                    const newStatus = isOnline ? 'online' : 'offline';
                    
                    if (newStatus !== connectionState.networkStatus) {
                        connectionState.networkStatus = newStatus;
                        if (!isOnline) {
                            showStatus('网络连接不稳定', 'warning');
                        }
                    }
                }
            }, ERROR_CONFIG.networkCheckInterval);
        }
        
        // 合约配置
        let CONTRACT_ADDRESS = ''; // 将在部署后填入
        const CONTRACT_ABI = [
            // AuctionPlatform ABI
            "function owner() view returns (address)",
            "function auctionCount() view returns (uint256)",
            "function platformFeePercentage() view returns (uint256)",
            "function createAuction(string memory title, string memory description, bytes32 encryptedReservePrice, bytes calldata inputProof, uint256 duration) external returns (uint256)",
            "function placeBid(uint256 auctionId, bytes32 encryptedBid, bytes calldata inputProof) external payable",
            "function getAuction(uint256 auctionId) view returns (tuple(uint256 id, string itemName, string itemDescription, address seller, uint256 startingPrice, uint256 creationTime, uint256 endTime, bool isActive, bool isSettled))",
            "function getBidCount(uint256 auctionId) view returns (uint256)",
            "function hasBid(uint256 auctionId, address bidder) view returns (bool)",
            "function bidderFunds(address bidder) view returns (uint256)",
            "function withdrawFunds() external",
            "function settleAuction(uint256 auctionId) external",
            "function emergencyStopAuction(uint256 auctionId) external",
            "function setPlatformFee(uint256 newFeePercentage) external",
            "function canSettleAuction(uint256 auctionId) view returns (bool)",
            "event AuctionCreated(uint256 indexed auctionId, address indexed seller, string itemName, uint256 endTime)",
            "event BidPlaced(uint256 indexed auctionId, address indexed bidder, uint256 timestamp)",
            "event AuctionSettled(uint256 indexed auctionId, address indexed winner, bool successful)"
        ];

        // 全局错误处理器 - 过滤扩展相关错误
        function setupGlobalErrorHandler() {
            // 扩展错误过滤模式
            const extensionPatterns = [
                'inject.js', 'inpage.js', 'contentScript.js', 'solana.js', 'btc.js', 'sui.js',
                'dapp-interface.js', 'solanaActionsContentScript.js', 'chrome-extension://',
                'moz-extension://', 'safari-extension://', 'Cannot destructure property',
                'Failed to execute \'observe\' on \'MutationObserver\'', 'ResizeObserver loop limit exceeded',
                'Non-Error promise rejection captured', 'Script error', 'Network request failed',
                'Loading chunk', 'Loading CSS chunk', 'ChunkLoadError',
                // 新增的错误过滤模式
                'bytehunter.cloud', 'url-whitelist.json', 'AxiosError',
                'Request failed with status code 451', 'Unavailable For Legal Reasons',
                'parameter 1 is not of type \'Node\'', 'extension://',
                'content_script', 'contentScript', 'chunk-', '.js:',
                'GET https://assets.bytehunter.cloud', 'XMLHttpRequest.send',
                'Promise.then', 'await in', 'Uncaught (in promise)'
            ];
            
            // 检查是否为扩展错误
            function isExtensionError(error, filename, message, stack) {
                return extensionPatterns.some(pattern => {
                    return filename?.includes(pattern) || 
                           message?.includes(pattern) ||
                           stack?.includes(pattern) ||
                           error?.toString()?.includes(pattern);
                });
            }
            
            // 全局错误监听
            window.addEventListener('error', (event) => {
                if (isExtensionError(event.error, event.filename, event.message, event.error?.stack)) {
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                }
                
                // 记录应用相关错误
                console.error('应用错误:', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    error: event.error,
                    timestamp: new Date().toISOString()
                });
                
                // 显示用户友好的错误信息
                if (event.message && !event.message.includes('Script error')) {
                    showStatus('应用遇到错误，请刷新页面重试', 'error');
                }
            });
            
            // 处理未捕获的Promise拒绝
            window.addEventListener('unhandledrejection', (event) => {
                const reason = event.reason;
                const stack = reason?.stack || '';
                const message = reason?.message || reason?.toString() || '';
                
                if (isExtensionError(reason, '', message, stack)) {
                    event.preventDefault();
                    return;
                }
                
                console.error('未处理的Promise拒绝:', {
                    reason: reason,
                    stack: stack,
                    timestamp: new Date().toISOString()
                });
                
                // 防止显示过多错误信息
                if (!message.includes('Loading') && !message.includes('Network')) {
                    showStatus('网络或加载错误，请检查连接', 'warning');
                }
                
                event.preventDefault();
            });
            
            // 控制台警告过滤
            const originalWarn = console.warn;
            console.warn = function(...args) {
                const message = args.join(' ');
                if (!isExtensionError(null, '', message, '')) {
                    originalWarn.apply(console, args);
                }
            };
        }

        // 网络连接检测
        function checkNetworkConnection() {
            return new Promise((resolve) => {
                if (!navigator.onLine) {
                    resolve(false);
                    return;
                }
                
                // 尝试获取一个小的资源来测试网络
                const img = new Image();
                const timeout = setTimeout(() => {
                    img.onload = img.onerror = null;
                    resolve(false);
                }, 3000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    resolve(true);
                };
                
                img.onerror = () => {
                    clearTimeout(timeout);
                    resolve(false);
                };
                
                // 使用一个小的图片来测试连接
                img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            });
        }
        
        // 检查FHEVM库是否可用
        function checkFhevmAvailability() {
            return new Promise((resolve) => {
                // 快速检查FHEVM库是否已经存在
                if (typeof window.fhevm !== 'undefined') {
                    resolve(true);
                    return;
                }
                
                // 检查是否有FHEVM相关的脚本标签
                const scripts = document.querySelectorAll('script[src*="fhevm"], script[src*="tfhe"]');
                if (scripts.length === 0) {
                    resolve(false);
                    return;
                }
                
                // 等待一小段时间看库是否会加载
                let attempts = 0;
                const maxAttempts = 10; // 1秒检查
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof window.fhevm !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
        }
        
        // 初始化
        async function init() {
            try {
                setupGlobalErrorHandler();
                
                // 启动网络监控
                startNetworkMonitoring();
                
                // 检查网络连接
                const isOnline = await checkNetworkConnection();
                if (!isOnline) {
                    showStatus('网络连接不可用，部分功能可能受限', 'warning');
                }
                
                await loadConfig();
                
                // 智能检查FHEVM库可用性
                const fhevmAvailable = await checkFhevmAvailability();
                
                if (isOnline && fhevmAvailable) {
                    await initializeFHEVM();
                } else {
                    if (!fhevmAvailable) {
                        console.info('FHEVM库不可用，使用模拟模式');
                    } else {
                        console.info('网络不可用，使用模拟模式');
                    }
                    useFhevmSimulation();
                }
                
                setupEventListeners();
                showStatus('系统初始化完成', 'info');
                
                // 页面加载完成后自动加载拍卖列表
                await loadAuctions();
                
                // 设置网络状态监听
                window.addEventListener('online', () => {
                    connectionState.isOnline = true;
                    showStatus('网络连接已恢复', 'success');
                });
                
                window.addEventListener('offline', () => {
                    connectionState.isOnline = false;
                    showStatus('网络连接已断开，切换到离线模式', 'warning');
                });
                
            } catch (error) {
                console.error('初始化失败:', error);
                // 即使初始化失败，也要设置事件监听器
                setupEventListeners();
                
                // 尝试使用模拟模式
                if (!fhevmInstance) {
                    useFhevmSimulation();
                }
                
                showStatus('系统初始化部分失败，已启用备用模式', 'warning');
            }
        }

        // 加载配置
        async function loadConfig() {
            try {
                const response = await fetch('/config.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const config = await response.json();
                CONTRACT_ADDRESS = config.contractAddress;
                console.log('配置文件加载成功，合约地址:', CONTRACT_ADDRESS);
            } catch (error) {
                console.warn('无法加载配置文件，使用默认设置:', error.message);
                // 使用默认合约地址
                CONTRACT_ADDRESS = '0x00a0c4c5a6c83578dd19db328b3d8381519221fe';
            }
        }

        // 显示FHEVM加载界面
        function showFhevmLoader() {
            const loader = document.getElementById('fhevmLoader');
            loader.classList.remove('hidden');
            
            // 绑定跳过按钮事件
            document.getElementById('skipFhevm').onclick = () => {
                hideFhevmLoader();
                useFhevmSimulation();
            };
        }
        
        // 隐藏FHEVM加载界面
        function hideFhevmLoader() {
            const loader = document.getElementById('fhevmLoader');
            loader.classList.add('hidden');
        }
        
        // 更新加载进度
        function updateFhevmProgress(percent, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }
        
        // 使用FHEVM模拟模式
        function useFhevmSimulation() {
            fhevmInstance = {
                encrypt64: (value) => {
                    const hash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(value.toString()));
                    return {
                        handles: [hash],
                        inputProof: '0x',
                        // 为了兼容合约调用，直接返回hash作为einput
                        valueOf: () => hash,
                        toString: () => hash
                    };
                },
                isSimulated: true
            };
            console.log('使用FHEVM模拟实例，应用功能可正常使用');
            showStatus('已切换到模拟模式，功能正常可用', 'info');
        }

        // 初始化FHEVM
        async function initializeFHEVM() {
            showFhevmLoader();
            updateFhevmProgress(10, '10% - 检查FHEVM库...');
            
            let retryCount = 0;
            const maxRetries = 2;
            
            while (retryCount <= maxRetries) {
                try {
                    // 检查FHEVM库是否已加载
                    if (typeof window.fhevm === 'undefined') {
                        updateFhevmProgress(20, '20% - 等待FHEVM库加载...');
                        
                        // 静默等待FHEVM库加载，不输出过多日志
                        await new Promise((resolve, reject) => {
                            let attempts = 0;
                            const maxAttempts = 50; // 5秒超时
                            
                            const checkFhevm = () => {
                                attempts++;
                                const progress = 20 + (attempts / maxAttempts) * 30;
                                updateFhevmProgress(progress, `${Math.round(progress)}% - 加载FHEVM库...`);
                                
                                if (typeof window.fhevm !== 'undefined') {
                                    resolve();
                                } else if (attempts >= maxAttempts) {
                                    reject(new Error('FHEVM库加载超时'));
                                } else {
                                    setTimeout(checkFhevm, 100);
                                }
                            };
                            checkFhevm();
                        });
                    }
                    
                    updateFhevmProgress(60, '60% - 初始化FHEVM实例...');
                    
                    // 尝试创建FHEVM实例
                    const createInstancePromise = window.fhevm.createInstance({
                        chainId: 11155111, // Sepolia测试网
                        networkUrl: 'https://sepolia.infura.io/v3/YOUR_INFURA_KEY',
                        gatewayUrl: 'https://gateway.sepolia.zama.ai'
                    });
                    
                    // 设置创建实例的超时
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('FHEVM实例创建超时')), 8000); // 8秒超时
                    });
                    
                    updateFhevmProgress(80, '80% - 创建FHEVM实例...');
                    fhevmInstance = await Promise.race([createInstancePromise, timeoutPromise]);
                    
                    updateFhevmProgress(100, '100% - 初始化完成!');
                    
                    setTimeout(() => {
                        hideFhevmLoader();
                        showStatus('FHEVM初始化成功，隐私保护已启用', 'success');
                    }, 500);
                    
                    return; // 成功退出
                    
                } catch (error) {
                    retryCount++;
                    
                    if (retryCount <= maxRetries) {
                        updateFhevmProgress(30, `重试中... (${retryCount}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, 2000)); // 等待2秒后重试
                        continue;
                    }
                    
                    // 所有重试都失败，静默切换到模拟模式
                    updateFhevmProgress(100, '切换到模拟模式');
                    
                    setTimeout(() => {
                        hideFhevmLoader();
                        useFhevmSimulation();
                    }, 1000);
                    break;
                }
            }
        }

        // 连接钱包（优化版）
        async function connectWallet() {
            const connectBtn = document.getElementById('connectWallet');
            const originalText = connectBtn.textContent;
            
            try {
                connectBtn.textContent = '连接中...';
                connectBtn.disabled = true;
                
                await retryWithBackoff(async () => {
                    // 检查MetaMask是否安装
                    if (typeof window.ethereum === 'undefined') {
                        throw new Error('请安装MetaMask钱包。访问 https://metamask.io 下载安装。');
                    }
                    
                    // 检查网络连接
                    const isOnline = await checkNetworkConnection();
                    if (!isOnline) {
                        throw new Error('网络连接不可用，请检查网络设置');
                    }
                    
                    // 请求账户访问权限
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    
                    if (!accounts || accounts.length === 0) {
                        throw new Error('未获取到账户信息，请确保MetaMask已解锁');
                    }
                    
                    // 创建provider和signer
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    // 检查网络
                    const network = await provider.getNetwork();
                    console.log('当前网络:', network);
                    
                    return { accounts, network };
                }, '钱包连接', 2); // 钱包连接最多重试2次
                
                // 尝试连接合约（独立处理，失败不影响钱包连接）
                if (CONTRACT_ADDRESS) {
                    try {
                        await retryWithBackoff(async () => {
                            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                            await checkUserRole();
                        }, '合约连接', 2);
                    } catch (contractError) {
                        console.warn('合约连接失败，但钱包连接成功:', contractError.message);
                        showStatus('钱包连接成功，但合约暂时不可用', 'warning');
                    }
                }
                
                // 更新UI和加载用户信息
                updateWalletUI();
                
                try {
                    await loadUserInfo();
                } catch (infoError) {
                    console.warn('加载用户信息失败:', infoError.message);
                }
                
                connectionState.isConnected = true;
                showStatus('钱包连接成功', 'success');
                
                // 设置事件监听器（只设置一次）
                setupWalletEventListeners();
                
            } catch (error) {
                console.error('钱包连接失败:', error);
                
                // 恢复按钮状态
                connectBtn.textContent = originalText;
                connectBtn.disabled = false;
                
                // 分类错误并提供友好信息
                const errorType = classifyError(error);
                let errorMessage = error.message;
                
                switch (errorType) {
                    case ERROR_TYPES.USER:
                        errorMessage = '用户取消了连接操作';
                        break;
                    case ERROR_TYPES.NETWORK:
                        errorMessage = '网络连接问题，请检查网络设置';
                        break;
                    case ERROR_TYPES.WALLET:
                        errorMessage = 'MetaMask钱包问题，请检查钱包状态';
                        break;
                    case ERROR_TYPES.TIMEOUT:
                        errorMessage = '连接超时，请重试';
                        break;
                    default:
                        if (error.code === -32002) {
                            errorMessage = 'MetaMask正在处理请求，请检查MetaMask窗口';
                        }
                }
                
                showStatus('钱包连接失败: ' + errorMessage, 'error');
            }
        }
        
        // 设置钱包事件监听器
        function setupWalletEventListeners() {
            // 避免重复绑定
            if (window.ethereum._listenersSetup) return;
            window.ethereum._listenersSetup = true;
            
            // 监听账户变化
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // 用户断开连接
                    resetWalletState();
                    showStatus('钱包已断开连接', 'info');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    // 账户切换
                    showStatus('检测到账户切换，正在重新加载...', 'info');
                    setTimeout(() => location.reload(), 500);
                }
            });
            
            // 监听网络变化
            window.ethereum.on('chainChanged', (chainId) => {
                console.log('网络已切换:', chainId);
                showStatus('检测到网络切换，正在重新加载...', 'info');
                setTimeout(() => location.reload(), 500);
            });
        }
        
        // 重置钱包状态
        function resetWalletState() {
            userAddress = null;
            contract = null;
            provider = null;
            signer = null;
            isOwner = false;
            connectionState.isConnected = false;
        }

        // 检查用户角色（优化版）
        async function checkUserRole() {
            if (!contract || !userAddress) return;
            
            try {
                await retryWithBackoff(async () => {
                    const owner = await contract.owner();
                    isOwner = userAddress.toLowerCase() === owner.toLowerCase();
                    
                    if (isOwner) {
                        document.getElementById('adminPanel').classList.remove('hidden');
                    }
                }, '检查用户角色', 2);
            } catch (error) {
                console.warn('检查用户角色失败:', error.message);
                // 角色检查失败不影响其他功能，静默处理
            }
        }

        // 更新钱包UI
        function updateWalletUI() {
            const connectBtn = document.getElementById('connectWallet');
            const addressSpan = document.getElementById('walletAddress');
            
            if (userAddress) {
                connectBtn.textContent = '已连接';
                connectBtn.disabled = true;
                addressSpan.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                addressSpan.classList.remove('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
            }
        }

        // 加载用户信息（优化版）
        async function loadUserInfo() {
            if (!userAddress) return;

            try {
                // 加载钱包余额（基础功能，优先级高）
                if (provider) {
                    await retryWithBackoff(async () => {
                        const balance = await provider.getBalance(userAddress);
                        document.getElementById('userBalance').textContent = 
                            parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
                    }, '加载钱包余额', 2);
                }
                
                // 加载合约相关信息（可选功能）
                if (contract) {
                    try {
                        await retryWithBackoff(async () => {
                            const lockedFunds = await contract.bidderFunds(userAddress);
                            document.getElementById('lockedFunds').textContent = 
                                parseFloat(ethers.utils.formatEther(lockedFunds)).toFixed(4);
                        }, '加载锁定资金', 2);
                    } catch (contractError) {
                        console.warn('加载锁定资金失败:', contractError.message);
                        document.getElementById('lockedFunds').textContent = '0.0000';
                    }
                }
                
                // 加载平台统计（独立处理）
                try {
                    await loadPlatformStats();
                } catch (statsError) {
                    console.warn('加载平台统计失败:', statsError.message);
                }
                
            } catch (error) {
                console.warn('加载用户信息部分失败:', error.message);
                // 设置默认值
                document.getElementById('userBalance').textContent = '0.0000';
                document.getElementById('lockedFunds').textContent = '0.0000';
            }
        }

        // 加载平台统计（优化版）
        async function loadPlatformStats() {
            if (!contract) {
                // 设置默认值
                document.getElementById('totalAuctions').textContent = '0';
                document.getElementById('platformFeeRate').textContent = '0';
                document.getElementById('activeAuctions').textContent = '0';
                return;
            }

            try {
                // 分步加载，避免单点失败影响所有数据
                let auctionCount = 0;
                let platformFee = 0;
                let activeCount = 0;
                
                // 加载基础统计
                try {
                    await retryWithBackoff(async () => {
                        auctionCount = await contract.auctionCount();
                        platformFee = await contract.platformFeePercentage();
                        
                        document.getElementById('totalAuctions').textContent = auctionCount.toString();
                        document.getElementById('platformFeeRate').textContent = platformFee.toString();
                    }, '加载基础统计', 2);
                } catch (basicError) {
                    console.warn('加载基础统计失败:', basicError.message);
                    document.getElementById('totalAuctions').textContent = '0';
                    document.getElementById('platformFeeRate').textContent = '0';
                }
                
                // 计算活跃拍卖数（可选功能，失败不影响其他数据）
                if (auctionCount > 0) {
                    try {
                        await retryWithBackoff(async () => {
                            const batchSize = 10; // 批量处理，避免一次性查询过多
                            const totalCount = auctionCount.toNumber();
                            
                            for (let i = 0; i < totalCount; i += batchSize) {
                                const endIndex = Math.min(i + batchSize, totalCount);
                                const promises = [];
                                
                                for (let j = i; j < endIndex; j++) {
                                    promises.push(
                                        contract.getAuction(j).catch(err => {
                                            console.warn(`获取拍卖 ${j} 失败:`, err.message);
                                            return null;
                                        })
                                    );
                                }
                                
                                const auctions = await Promise.all(promises);
                                auctions.forEach(auction => {
                                    if (auction && auction.isActive) {
                                        activeCount++;
                                    }
                                });
                            }
                            
                            document.getElementById('activeAuctions').textContent = activeCount.toString();
                        }, '计算活跃拍卖', 1); // 只重试1次
                    } catch (activeError) {
                        console.warn('计算活跃拍卖失败:', activeError.message);
                        document.getElementById('activeAuctions').textContent = '0';
                    }
                } else {
                    document.getElementById('activeAuctions').textContent = '0';
                }
                
            } catch (error) {
                console.warn('加载平台统计失败:', error.message);
                // 设置默认值
                document.getElementById('totalAuctions').textContent = '0';
                document.getElementById('platformFeeRate').textContent = '0';
                document.getElementById('activeAuctions').textContent = '0';
            }
        }

        // 创建拍卖（优化版）
        async function createAuction() {
            if (!contract || !userAddress) {
                showStatus('请先连接钱包', 'error');
                return;
            }

            if (!connectionState.isOnline) {
                showStatus('网络连接不可用，无法创建拍卖', 'error');
                return;
            }

            const itemName = document.getElementById('itemName').value.trim();
            const itemDescription = document.getElementById('itemDescription').value.trim();
            const startingPrice = document.getElementById('startingPrice').value;
            const reservePrice = document.getElementById('reservePrice').value;
            const duration = document.getElementById('auctionDuration').value;

            // 输入验证
            if (!itemName || !itemDescription || !startingPrice || !reservePrice || !duration) {
                showStatus('请填写完整信息', 'error');
                return;
            }

            // 价格验证
            try {
                const startingPriceNum = parseFloat(startingPrice);
                const reservePriceNum = parseFloat(reservePrice);
                const durationNum = parseInt(duration);
                
                if (startingPriceNum <= 0 || reservePriceNum <= 0 || durationNum <= 0) {
                    showStatus('价格和时长必须大于0', 'error');
                    return;
                }
                
                if (reservePriceNum < startingPriceNum) {
                    showStatus('保留价格不能低于起始价格', 'error');
                    return;
                }
                
                if (durationNum > 168) { // 最长7天
                    showStatus('拍卖时长不能超过168小时（7天）', 'error');
                    return;
                }
            } catch (validationError) {
                showStatus('请输入有效的数字', 'error');
                return;
            }

            try {
                showStatus('正在创建拍卖...', 'info');
                
                // 使用智能重试机制创建拍卖
                await retryWithBackoff(async () => {
                    const startingPriceWei = ethers.utils.parseEther(startingPrice);
                    const reservePriceWei = ethers.utils.parseEther(reservePrice);
                    const durationInSeconds = parseInt(duration) * 60 * 60;
                    
                    // 加密保留价格
                    const encryptedReservePrice = fhevmInstance.encrypt64(reservePriceWei.toString());
                    
                    // 确保 inputProof 不为空
                    const inputProof = encryptedReservePrice.inputProof || '0x00';
                    
                    console.log('创建拍卖参数:', {
                        itemName,
                        itemDescription,
                        encryptedReservePrice: encryptedReservePrice.handles[0],
                        inputProof,
                        durationInSeconds
                    });
                    
                    // 发送交易
                    const tx = await contract.createAuction(
                        itemName,
                        itemDescription,
                        encryptedReservePrice.handles[0],
                        inputProof,
                        durationInSeconds
                    );
                    
                    showStatus('交易已发送，等待确认...', 'info');
                    
                    // 等待交易确认，设置超时
                    const receipt = await Promise.race([
                        tx.wait(),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('交易确认超时')), 60000) // 60秒超时
                        )
                    ]);
                    
                    if (!receipt.status) {
                        throw new Error('交易执行失败');
                    }
                    
                    return receipt;
                }, '创建拍卖', 2);
                
                showStatus('拍卖创建成功', 'success');
                
                // 清空表单
                document.getElementById('itemName').value = '';
                document.getElementById('itemDescription').value = '';
                document.getElementById('startingPrice').value = '';
                document.getElementById('reservePrice').value = '';
                document.getElementById('auctionDuration').value = '';
                
                // 切换到拍卖列表并刷新
                switchTab('auctions');
                
                // 延迟刷新，确保区块链状态更新
                setTimeout(async () => {
                    await loadAuctions();
                }, 2000);
                
            } catch (error) {
                console.error('创建拍卖失败:', error);
                
                const errorType = classifyError(error);
                let errorMessage = error.message;
                
                if (errorType === ERROR_TYPES.NETWORK) {
                    errorMessage = '网络连接失败，请检查网络后重试';
                } else if (errorType === ERROR_TYPES.CONTRACT) {
                    errorMessage = '合约交互失败，请检查钱包连接';
                } else if (errorType === ERROR_TYPES.USER_REJECTED) {
                    errorMessage = '用户取消了交易';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = '余额不足，请确保有足够的ETH支付gas费用';
                } else if (error.message.includes('timeout') || error.message.includes('超时')) {
                    errorMessage = '操作超时，请重试';
                }
                
                showStatus('创建拍卖失败: ' + errorMessage, 'error');
            }
        }

        // 测试拍卖数据
        const testAuctions = [
            {
                id: 0,
                itemName: "🎨 数字艺术作品 - 星空幻想",
                itemDescription: "由知名数字艺术家创作的限量版NFT作品，展现了宇宙星空的神秘与美丽。采用4K分辨率，包含动态效果。",
                seller: "0x1234567890123456789012345678901234567890",
                startingPrice: ethers.utils.parseEther("0.1"),
                creationTime: Math.floor(Date.now() / 1000) - 3600,
                endTime: Math.floor(Date.now() / 1000) + 86400,
                isActive: true,
                isSettled: false
            },
            {
                id: 1,
                itemName: "⌚ 限量版智能手表",
                itemDescription: "全新未拆封的限量版智能手表，具备健康监测、GPS定位、防水等功能。全球限量1000台。",
                seller: "0x2345678901234567890123456789012345678901",
                startingPrice: ethers.utils.parseEther("0.5"),
                creationTime: Math.floor(Date.now() / 1000) - 7200,
                endTime: Math.floor(Date.now() / 1000) + 172800,
                isActive: true,
                isSettled: false
            },
            {
                id: 2,
                itemName: "📚 稀有古籍收藏",
                itemDescription: "19世纪的珍贵古籍，保存完好，具有极高的收藏价值。经过专业鉴定，确认为真品。",
                seller: "0x3456789012345678901234567890123456789012",
                startingPrice: ethers.utils.parseEther("2.0"),
                creationTime: Math.floor(Date.now() / 1000) - 10800,
                endTime: Math.floor(Date.now() / 1000) + 259200,
                isActive: true,
                isSettled: false
            },
            {
                id: 3,
                itemName: "🏆 体育纪念品",
                itemDescription: "著名运动员签名的限量版球衣，附带官方认证证书。对体育收藏爱好者来说是珍贵的收藏品。",
                seller: "0x4567890123456789012345678901234567890123",
                startingPrice: ethers.utils.parseEther("0.8"),
                creationTime: Math.floor(Date.now() / 1000) - 14400,
                endTime: Math.floor(Date.now() / 1000) + 345600,
                isActive: true,
                isSettled: false
            },
            {
                id: 4,
                itemName: "💎 精美珠宝首饰",
                itemDescription: "手工制作的精美项链，镶嵌天然宝石，设计独特。附带珠宝鉴定证书，确保品质。",
                seller: "0x5678901234567890123456789012345678901234",
                startingPrice: ethers.utils.parseEther("1.5"),
                creationTime: Math.floor(Date.now() / 1000) - 18000,
                endTime: Math.floor(Date.now() / 1000) + 432000,
                isActive: true,
                isSettled: false
            },
            {
                id: 5,
                itemName: "🎮 复古游戏机",
                itemDescription: "80年代经典游戏机，功能完好，包含原装手柄和多款经典游戏卡带。怀旧游戏爱好者的最爱。",
                seller: "0x6789012345678901234567890123456789012345",
                startingPrice: ethers.utils.parseEther("0.3"),
                creationTime: Math.floor(Date.now() / 1000) - 21600,
                endTime: Math.floor(Date.now() / 1000) + 518400,
                isActive: true,
                isSettled: false
            }
        ];

        // 性能监控
        const performanceMonitor = {
            startTime: null,
            
            start(operation) {
                this.startTime = performance.now();
                console.log(`开始执行: ${operation}`);
            },
            
            end(operation) {
                if (this.startTime) {
                    const duration = performance.now() - this.startTime;
                    console.log(`${operation} 完成，耗时: ${duration.toFixed(2)}ms`);
                    this.startTime = null;
                    return duration;
                }
            }
        };
        
        // 加载拍卖列表（优化版）
        async function loadAuctions() {
            performanceMonitor.start('加载拍卖列表');
            
            try {
                showStatus('正在加载拍卖...', 'info');
                
                const auctionsList = document.getElementById('auctionsList');
                
                // 显示加载动画
                auctionsList.innerHTML = `
                    <div class="loading-container" style="text-align: center; padding: 40px;">
                        <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                        <p style="color: #666;">正在加载拍卖数据...</p>
                    </div>
                `;

                // 如果合约可用，尝试加载真实数据
                if (contract && connectionState.isOnline) {
                    try {
                        // 使用智能重试机制加载拍卖数量
                        const auctionCount = await retryWithBackoff(async () => {
                            return await Promise.race([
                                contract.auctionCount(),
                                new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('合约调用超时')), 8000)
                                )
                            ]);
                        }, '获取拍卖数量', 2);
                        
                        if (auctionCount.gt(0)) {
                            auctionsList.innerHTML = ''; // 清除加载动画
                            
                            let myAuctionsCount = 0;
                            let myBidsCount = 0;
                            const loadPromises = [];
                            const batchSize = 5; // 批量处理大小
                            const totalCount = auctionCount.toNumber();

                            // 分批加载拍卖数据，避免一次性加载过多
                            for (let i = totalCount - 1; i >= 0; i -= batchSize) {
                                const batchPromises = [];
                                const startIndex = Math.max(0, i - batchSize + 1);
                                
                                for (let j = i; j >= startIndex; j--) {
                                    const loadPromise = retryWithBackoff(async () => {
                                        try {
                                            const [auction, hasBid, bidCount] = await Promise.all([
                                                contract.getAuction(j),
                                                userAddress ? contract.hasBid(j, userAddress).catch(() => false) : Promise.resolve(false),
                                                contract.getBidCount(j).catch(() => ({ toString: () => '0' }))
                                            ]);
                                            
                                            if (userAddress && auction.seller.toLowerCase() === userAddress.toLowerCase()) {
                                                myAuctionsCount++;
                                            }
                                            if (hasBid) {
                                                myBidsCount++;
                                            }

                                            return { auction, i: j, hasBid, bidCount };
                                        } catch (error) {
                                            const errorType = classifyError(error);
                                            if (errorType === ERROR_TYPES.NETWORK) {
                                                throw error; // 网络错误需要重试
                                            }
                                            console.warn(`加载拍卖 ${j} 失败:`, error.message);
                                            return null;
                                        }
                                    }, `加载拍卖${j}`, 1).catch(error => {
                                        console.warn(`拍卖 ${j} 重试失败:`, error.message);
                                        return null;
                                    });
                                    
                                    batchPromises.push(loadPromise);
                                }
                                
                                // 等待当前批次完成
                                const batchResults = await Promise.all(batchPromises);
                                loadPromises.push(...batchResults);
                                
                                // 批次间短暂延迟，避免过载
                                if (i > startIndex) {
                                    await new Promise(resolve => setTimeout(resolve, 100));
                                }
                            }
                            
                            // 渲染拍卖卡片
                            const validResults = loadPromises.filter(result => result !== null);
                            validResults.forEach(({ auction, i, hasBid, bidCount }) => {
                                const auctionCard = createAuctionCard(auction, i, hasBid, bidCount);
                                auctionsList.appendChild(auctionCard);
                            });

                            // 更新用户统计
                            document.getElementById('myAuctions').textContent = myAuctionsCount.toString();
                            document.getElementById('myBids').textContent = myBidsCount.toString();
                            
                            const duration = performanceMonitor.end('加载拍卖列表');
                            const successCount = validResults.length;
                            const failCount = totalCount - successCount;
                            
                            if (failCount > 0) {
                                showStatus(`拍卖加载完成 (${successCount}/${totalCount}个成功，${failCount}个失败，耗时${duration.toFixed(0)}ms)`, 'warning');
                            } else {
                                showStatus(`拍卖加载完成 (${successCount}个拍卖，耗时${duration.toFixed(0)}ms)`, 'success');
                            }
                            return;
                        }
                    } catch (error) {
                        const errorType = classifyError(error);
                        console.warn('加载合约数据失败，使用测试数据:', error.message);
                        
                        if (errorType === ERROR_TYPES.NETWORK) {
                            showStatus('网络连接问题，正在使用测试数据', 'warning');
                        } else {
                            showStatus('合约连接问题，正在使用测试数据', 'warning');
                        }
                    }
                }
                
                // 使用测试数据
                auctionsList.innerHTML = ''; // 清除加载动画
                
                // 模拟加载延迟以展示加载状态
                await new Promise(resolve => setTimeout(resolve, 500));
                
                testAuctions.forEach((auction, index) => {
                    const bidCount = { toString: () => Math.floor(Math.random() * 10) + 1 };
                    const hasBid = Math.random() > 0.7; // 30% 概率已参与竞拍
                    const auctionCard = createAuctionCard(auction, index, hasBid, bidCount, true);
                    auctionsList.appendChild(auctionCard);
                });
                
                // 更新测试统计数据
                document.getElementById('myAuctions').textContent = '2';
                document.getElementById('myBids').textContent = '3';
                
                const duration = performanceMonitor.end('加载拍卖列表');
                showStatus(`演示数据加载完成 (测试模式，耗时${duration.toFixed(0)}ms)`, 'info');
                
            } catch (error) {
                console.error('加载拍卖失败:', error);
                
                const errorType = classifyError(error);
                let errorMessage = error.message;
                let retryText = '重试';
                
                if (errorType === ERROR_TYPES.NETWORK) {
                    errorMessage = '网络连接失败，请检查网络设置';
                    retryText = '检查网络并重试';
                } else if (errorType === ERROR_TYPES.CONTRACT) {
                    errorMessage = '合约连接失败，请检查钱包连接';
                    retryText = '重新连接钱包';
                }
                
                // 显示错误状态
                const auctionsList = document.getElementById('auctionsList');
                auctionsList.innerHTML = `
                    <div class="error-container" style="text-align: center; padding: 40px; color: #e53e3e;">
                        <h3>加载失败</h3>
                        <p>${errorMessage}</p>
                        <button onclick="loadAuctions()" class="btn btn-primary" style="margin-top: 20px;">${retryText}</button>
                    </div>
                `;
                
                performanceMonitor.end('加载拍卖列表');
                showStatus('加载拍卖失败: ' + errorMessage, 'error');
            }
        }

        // 创建拍卖卡片
        function createAuctionCard(auction, auctionId, hasBid, bidCount, isTestMode = false) {
            const card = document.createElement('div');
            card.className = 'auction-card';
            
            const now = Math.floor(Date.now() / 1000);
            const isActive = auction.isActive && now < auction.endTime;
            const isOwner = userAddress && auction.seller.toLowerCase() === userAddress.toLowerCase();
            const canBid = isActive && !isOwner && userAddress;

            let statusClass = 'ended';
            let statusText = '已结束';
            if (auction.isSettled) {
                statusClass = 'settled';
                statusText = '已结算';
            } else if (isActive) {
                statusClass = 'active';
                statusText = '进行中';
            }

            const timeRemaining = auction.endTime - now;
            const countdownId = `countdown-${auctionId}`;

            card.innerHTML = `
                <div class="auction-header">
                    <div class="auction-title">${auction.itemName}</div>
                    <div class="auction-status ${statusClass}">${statusText}</div>
                </div>
                <div class="auction-description">${auction.itemDescription}</div>
                <div class="auction-details">
                    <div class="detail-row">
                        <span class="detail-label">卖家:</span>
                        <span class="detail-value">${auction.seller.slice(0, 6)}...${auction.seller.slice(-4)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">起拍价:</span>
                        <span class="detail-value price-highlight">${ethers.utils.formatEther(auction.startingPrice)} ETH</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">竞拍次数:</span>
                        <span class="detail-value">${bidCount.toString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">创建时间:</span>
                        <span class="detail-value">${new Date(auction.creationTime * 1000).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">结束时间:</span>
                        <span class="detail-value">${new Date(auction.endTime * 1000).toLocaleString()}</span>
                    </div>
                    ${hasBid ? '<div class="detail-row"><span class="detail-label" style="color: #48bb78; font-weight: 600;">✅ 已参与竞拍</span></div>' : ''}
                </div>
                ${isActive ? `<div id="${countdownId}" class="countdown"></div>` : ''}
                ${canBid ? `
                    <div class="bid-section">
                        <div class="bid-input-group">
                            <input type="number" id="bidAmount-${auctionId}" class="bid-input" placeholder="出价金额 (ETH)" step="0.001" min="${ethers.utils.formatEther(auction.startingPrice)}">
                            <button class="btn" onclick="${isTestMode ? 'demoPlaceBid' : 'placeBid'}(${auctionId})">${isTestMode ? '演示出价' : '出价'}</button>
                        </div>
                    </div>
                ` : ''}
                ${isOwner && !auction.isSettled ? `
                    <div class="bid-section">
                        <button class="btn btn-success" onclick="${isTestMode ? 'demoSettleAuction' : 'settleAuction'}(${auctionId})">${isTestMode ? '演示结算' : '结算拍卖'}</button>
                    </div>
                ` : ''}
                ${isTestMode && !canBid && !isOwner ? `
                    <div class="bid-section">
                        <button class="btn btn-secondary" onclick="showStatus('这是演示模式，请连接钱包体验真实功能', 'info')">连接钱包参与</button>
                    </div>
                ` : ''}
            `;

            // 启动倒计时
            if (isActive && timeRemaining > 0) {
                startCountdown(countdownId, timeRemaining);
            }

            return card;
        }

        // 启动倒计时
        function startCountdown(elementId, timeRemaining) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const updateCountdown = () => {
                if (timeRemaining <= 0) {
                    element.textContent = '拍卖已结束';
                    clearInterval(countdownIntervals[elementId]);
                    return;
                }

                const hours = Math.floor(timeRemaining / 3600);
                const minutes = Math.floor((timeRemaining % 3600) / 60);
                const seconds = timeRemaining % 60;

                element.textContent = `剩余时间: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timeRemaining--;
            };

            updateCountdown();
            countdownIntervals[elementId] = setInterval(updateCountdown, 1000);
        }

        // 出价
        async function placeBid(auctionId) {
            if (!contract || !userAddress) {
                showStatus('请先连接钱包', 'error');
                return;
            }

            const bidAmountInput = document.getElementById(`bidAmount-${auctionId}`);
            const bidAmount = bidAmountInput.value;

            if (!bidAmount || parseFloat(bidAmount) <= 0) {
                showStatus('请输入有效的出价金额', 'error');
                return;
            }

            try {
                showStatus('正在提交出价...', 'info');
                
                const bidAmountWei = ethers.utils.parseEther(bidAmount);
                
                // 加密出价金额
                const encryptedBid = fhevmInstance.encrypt64(bidAmountWei.toString());
                
                const tx = await contract.placeBid(
                    auctionId,
                    encryptedBid.handles[0],
                    encryptedBid.inputProof,
                    { value: bidAmountWei }
                );
                
                await tx.wait();
                showStatus('出价提交成功', 'success');
                
                // 清空输入框并刷新
                bidAmountInput.value = '';
                await loadAuctions();
                await loadUserInfo();
            } catch (error) {
                console.error('出价失败:', error);
                showStatus('出价失败: ' + error.message, 'error');
            }
        }

        // 结算拍卖
        async function settleAuction(auctionId) {
            if (!contract || !userAddress) {
                showStatus('请先连接钱包', 'error');
                return;
            }

            try {
                showStatus('正在结算拍卖...', 'info');
                
                const tx = await contract.settleAuction(auctionId);
                await tx.wait();
                
                showStatus('拍卖结算成功', 'success');
                await loadAuctions();
                await loadUserInfo();
            } catch (error) {
                console.error('结算失败:', error);
                showStatus('结算失败: ' + error.message, 'error');
            }
        }

        // 演示模式出价
        function demoPlaceBid(auctionId) {
            const bidAmountInput = document.getElementById(`bidAmount-${auctionId}`);
            const bidAmount = bidAmountInput.value;

            if (!bidAmount || parseFloat(bidAmount) <= 0) {
                showStatus('请输入有效的出价金额', 'error');
                return;
            }

            showStatus(`演示出价成功！出价金额: ${bidAmount} ETH`, 'success');
            bidAmountInput.value = '';
            
            // 模拟更新竞拍次数
            setTimeout(() => {
                showStatus('这是演示模式，连接钱包后可体验真实功能', 'info');
            }, 2000);
        }

        // 演示模式结算
         function demoSettleAuction(auctionId) {
             showStatus('演示结算成功！', 'success');
             setTimeout(() => {
                 showStatus('这是演示模式，连接钱包后可体验真实功能', 'info');
             }, 2000);
         }

        // 提取资金
        async function withdrawFunds() {
            if (!contract || !userAddress) {
                showStatus('请先连接钱包', 'error');
                return;
            }

            try {
                showStatus('正在提取资金...', 'info');
                
                const tx = await contract.withdrawFunds();
                await tx.wait();
                
                showStatus('资金提取成功', 'success');
                await loadUserInfo();
            } catch (error) {
                console.error('提取资金失败:', error);
                showStatus('提取资金失败: ' + error.message, 'error');
            }
        }

        // 设置平台费率
        async function setPlatformFee() {
            if (!contract || !isOwner) {
                showStatus('只有管理员可以设置平台费率', 'error');
                return;
            }

            const feePercentage = document.getElementById('platformFee').value;
            if (!feePercentage || parseFloat(feePercentage) < 0 || parseFloat(feePercentage) > 10) {
                showStatus('请输入有效的费率 (0-10%)', 'error');
                return;
            }

            try {
                showStatus('正在设置平台费率...', 'info');
                
                const tx = await contract.setPlatformFee(Math.floor(parseFloat(feePercentage) * 100));
                await tx.wait();
                
                showStatus('平台费率设置成功', 'success');
                await loadPlatformStats();
            } catch (error) {
                console.error('设置平台费率失败:', error);
                showStatus('设置平台费率失败: ' + error.message, 'error');
            }
        }

        // 紧急停止拍卖
        async function emergencyStopAuction() {
            if (!contract || !isOwner) {
                showStatus('只有管理员可以紧急停止拍卖', 'error');
                return;
            }

            const auctionId = document.getElementById('emergencyAuctionId').value;
            if (!auctionId || parseInt(auctionId) < 0) {
                showStatus('请输入有效的拍卖ID', 'error');
                return;
            }

            try {
                showStatus('正在紧急停止拍卖...', 'info');
                
                const tx = await contract.emergencyStopAuction(parseInt(auctionId));
                await tx.wait();
                
                showStatus('拍卖已紧急停止', 'success');
                await loadAuctions();
            } catch (error) {
                console.error('紧急停止失败:', error);
                showStatus('紧急停止失败: ' + error.message, 'error');
            }
        }

        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的活跃状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签内容
            document.getElementById(tabName).classList.add('active');
            
            // 激活选中的标签
            event.target.classList.add('active');
        }

        // 显示状态消息
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // 设置事件监听器
        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('createAuction').addEventListener('click', createAuction);
            document.getElementById('loadAuctions').addEventListener('click', loadAuctions);
            document.getElementById('withdrawFunds').addEventListener('click', withdrawFunds);
            document.getElementById('setPlatformFee').addEventListener('click', setPlatformFee);
            document.getElementById('emergencyStop').addEventListener('click', emergencyStopAuction);

            // 监听账户变化
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        location.reload();
                    } else {
                        location.reload();
                    }
                });

                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);

        // 全局函数，供HTML调用
        window.placeBid = placeBid;
        window.settleAuction = settleAuction;
        window.switchTab = switchTab;
    </script>
</body>
</html>